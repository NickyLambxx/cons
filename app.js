/* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è ‚Äî –ó–∞—â–∏—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è */
const $ = (s, r = document) => r.querySelector(s);
const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

function safeAddListener(selector, event, handler) {
    const el = $(selector);
    if (el) el.addEventListener(event, handler);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const state = {
    markersMode: false,
    showFavoritesOnly: false,
    articles: [],
    favorites: new Set(),
    favFolders: ['General'],
    articleFolders: {},
    currentFolderFilter: 'all',
    notes: {},
    returnPosition: null,
    landingPosition: null,
    isJumping: false,
    fontSize: 16,
    lineHeight: 1.6,
    searchHistory: [],
    progress: {},
    activeSearchQuery: '',
    speech: null,
    audio: {
        currentArticleId: null,
        isPlaying: false,
        rate: 1.0,
        utterance: null
    },
    mapZoom: 1,
    mapPan: { x: 0, y: 0 }
};

const LS = {
    THEME: 'ic-theme',
    MARKERS: 'ic-markers-mode',
    FAVORITES: 'ic-favorites',
    FAV_FOLDERS: 'ic-fav-folders-list',
    ARTICLE_FOLDERS: 'ic-article-folders-map',
    NOTES: 'ic-user-notes',
    FONT: 'ic-font-settings',
    FONT_TYPE: 'ic-font-type',
    HIGHSCORE: 'ic-game-highscore',
    SEARCH: 'ic-search-history',
    PROGRESS: 'ic-chapter-progress',
    CACHE_CHAPTERS: 'ic-chapters-cache'
};

// --- –°–õ–û–í–ê–†–¨ –¢–ï–†–ú–ò–ù–û–í (–¢–æ–ª—å–∫–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏) ---
const DICTIONARY = {
    "–∞–¥–≤–æ–∫–∞—Ç": "–ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç, –æ–∫–∞–∑—ã–≤–∞—é—â–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –ø–æ–º–æ—â—å (—Å—Ç. 48 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–º–æ—â—å –∞–¥–≤–æ–∫–∞—Ç–∞).",
    "–∞–º–Ω–∏—Å—Ç–∏—è": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –Ω–∞–∫–∞–∑–∞–Ω–∏—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫—Ä—É–≥–∞ –ª–∏—Ü, –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º–æ–π (—Å—Ç. 103).",
    "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω–æ—Å—Ç–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏, –æ–±—â–µ—Å—Ç–≤–∞ –∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (–≤–µ–¥–µ–Ω–∏–µ –†–§ - —Å—Ç. 71).",
    "–±—é–¥–∂–µ—Ç": "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç ‚Äî –ø–ª–∞–Ω –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–π –≤ –≤–∏–¥–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ (—Å—Ç. 114).",
    "–≤–∞–ª—é—Ç–∞": "–î–µ–Ω–µ–∂–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Å—Ç—Ä–∞–Ω—ã. –í –†–§ —Ä—É–±–ª—å —è–≤–ª—è–µ—Ç—Å—è –∑–∞–∫–æ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å—Ä–µ–¥—Å—Ç–≤–æ–º (—Å—Ç. 75).",
    "–≤–µ—Ä–æ–∏—Å–ø–æ–≤–µ–¥–∞–Ω–∏–µ": "–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –∫–∞–∫–æ–π-–ª–∏–±–æ —Ä–µ–ª–∏–≥–∏–∏ –∏–ª–∏ –æ—Ç–∫–∞–∑ –æ—Ç –Ω–µ—ë, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–±–æ–¥–∞ —Å–æ–≤–µ—Å—Ç–∏ (—Å—Ç. 28).",
    "–≤–ª–∞—Å—Ç—å": "–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ª—é–¥–µ–π. –í –†–§ –≤–ª–∞—Å—Ç—å –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—É—é, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏ —Å—É–¥–µ–±–Ω—É—é (—Å—Ç. 10).",
    "–≤—ã–±–æ—Ä—ã": "–°–≤–æ–±–æ–¥–Ω–æ–µ –≤–æ–ª–µ–∏–∑—ä—è–≤–ª–µ–Ω–∏–µ –≥—Ä–∞–∂–¥–∞–Ω –ø—Ä–∏ –∏–∑–±—Ä–∞–Ω–∏–∏ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –∏ –¥–µ–ø—É—Ç–∞—Ç–æ–≤ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º—ã (—Å—Ç. 3, 32).",
    "–≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ": "–£—Å—Ç–æ–π—á–∏–≤–∞—è –ø—Ä–∞–≤–æ–≤–∞—è —Å–≤—è–∑—å –ª–∏—Ü–∞ —Å –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–µ–π (—Å—Ç. 6).",
    "–¥–µ–º–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–æ–µ": "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –†–§ –∫–∞–∫ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –≥–¥–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –≤–ª–∞—Å—Ç–∏ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—Ä–æ–¥ (—Å—Ç. 1).",
    "–¥–µ–ø—É—Ç–∞—Ç": "–ò–∑–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –Ω–∞—Ä–æ–¥–∞ –≤ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º–µ (—Å—Ç. 97).",
    "–¥–æ–≥–æ–≤–æ—Ä": "–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Å—Ç–æ—Ä–æ–Ω. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–∞–≤–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –†–§ (—Å—Ç. 15).",
    "–¥—É–º–µ": "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –î—É–º–∞ ‚Äî –Ω–∏–∂–Ω—è—è –ø–∞–ª–∞—Ç–∞ –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞ –†–§ (—Å—Ç. 95).",
    "–∂–∏–ª–∏—â–µ": "–ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ (—Å—Ç. 25).",
    "–∑–∞–∫–æ–Ω": "–ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–∞–≤–æ–≤–æ–π –∞–∫—Ç, –æ–±–ª–∞–¥–∞—é—â–∏–π –≤—ã—Å—à–µ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Å–∏–ª–æ–π (–ø–æ—Å–ª–µ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏) (—Å—Ç. 15, 76).",
    "–∑–¥–æ—Ä–æ–≤—å–µ": "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∏ –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è. –ö–∞–∂–¥—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –æ—Ö—Ä–∞–Ω—É –∑–¥–æ—Ä–æ–≤—å—è (—Å—Ç. 41).",
    "–∏–º—É—â–µ—Å—Ç–≤–æ": "–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≥—Ä–∞–∂–¥–∞–Ω –∏–ª–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (—Å—Ç. 35).",
    "–∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è": "–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–∫–æ–Ω –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –∏–º–µ—é—â–∏–π –≤—ã—Å—à—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Å–∏–ª—É –∏ –ø—Ä—è–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—Å—Ç. 15).",
    "–º–µ—Å—Ç–Ω–æ–µ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞—Å–µ–ª–µ–Ω–∏–µ–º –≤–æ–ø—Ä–æ—Å–æ–≤ –º–µ—Å—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (—Å—Ç. 12, 130).",
    "–Ω–∞–ª–æ–≥–∏": "–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏, –≤–∑–∏–º–∞–µ–º—ã–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º. –ö–∞–∂–¥—ã–π –æ–±—è–∑–∞–Ω –ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–æ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–ª–æ–≥–∏ (—Å—Ç. 57).",
    "–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ": "–ü–µ—Ä–µ—Ö–æ–¥ –∏–º—É—â–µ—Å—Ç–≤–∞ —É–º–µ—Ä—à–µ–≥–æ –∫ –¥—Ä—É–≥–∏–º –ª–∏—Ü–∞–º. –ü—Ä–∞–≤–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è (—Å—Ç. 35).",
    "–æ–±–æ—Ä–æ–Ω–∞": "–°–∏—Å—Ç–µ–º–∞ –º–µ—Ä –ø–æ –∑–∞—â–∏—Ç–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –Ω–∞–ø–∞–¥–µ–Ω–∏—è (—Å—Ç. 71, 87).",
    "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "–¶–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è. –û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—â–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (—Å—Ç. 43).",
    "–æ—Ö—Ä–∞–Ω–∞": "–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –ø–æ –∑–∞—â–∏—Ç–µ –ø—Ä–∞–≤, –ø—Ä–∏—Ä–æ–¥—ã, –∑–¥–æ—Ä–æ–≤—å—è –∏ —Ç.–¥. (—Å—Ç. 9, 41).",
    "–ø–µ–Ω—Å–∏—è": "–†–µ–≥—É–ª—è—Ä–Ω–∞—è –¥–µ–Ω–µ–∂–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞ –≥—Ä–∞–∂–¥–∞–Ω–∞–º (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É, –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏). –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º (—Å—Ç. 39).",
    "–ø–æ–º–∏–ª–æ–≤–∞–Ω–∏–µ": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞ –æ—Ç –Ω–∞–∫–∞–∑–∞–Ω–∏—è, –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º –†–§ (—Å—Ç. 89).",
    "–ø–æ—à–ª–∏–Ω—ã": "–î–µ–Ω–µ–∂–Ω—ã–µ —Å–±–æ—Ä—ã, –≤–∑–∏–º–∞–µ–º—ã–µ —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–º–∏ –æ—Ä–≥–∞–Ω–∞–º–∏ (—Å—Ç. 71, 74).",
    "–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ": "–í—ã—Å—à–∏–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏ –†–§ (—Å—Ç. 110).",
    "–ø—Ä–∞–≤–æ–≤–æ–µ": "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –≥–¥–µ –∑–∞–∫–æ–Ω –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ (—Å—Ç. 1).",
    "–ø—Ä–∞–≤–æ—Å—É–¥–∏–µ": "–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—É–¥–æ–≤ –ø–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é –¥–µ–ª (—Å—Ç. 118).",
    "–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç": "–ì–ª–∞–≤–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –≥–∞—Ä–∞–Ω—Ç –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏ –†–§ (—Å—Ç. 80).",
    "–ø—Ä–∏—Å—è–≥–∞": "–¢–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–µ—â–∞–Ω–∏–µ, –¥–∞–≤–∞–µ–º–æ–µ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ –¥–æ–ª–∂–Ω–æ—Å—Ç—å (—Å—Ç. 82).",
    "–ø—Ä–æ–∫—É—Ä–æ—Ä": "–î–æ–ª–∂–Ω–æ—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ, –æ—Å—É—â–µ—Å—Ç–≤–ª—è—é—â–µ–µ –Ω–∞–¥–∑–æ—Ä –∑–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –∑–∞–∫–æ–Ω–æ–≤ (—Å—Ç. 129).",
    "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∞—è": "–§–æ—Ä–º–∞ –ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–§, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –≥–ª–∞–≤–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –∏–∑–±–∏—Ä–∞–µ—Ç—Å—è (—Å—Ç. 1).",
    "—Ä–µ—Ñ–µ—Ä–µ–Ω–¥—É–º": "–í—Å–µ–Ω–∞—Ä–æ–¥–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ –≤–∞–∂–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º (—Å—Ç. 3).",
    "—Å–≤–µ—Ç—Å–∫–æ–µ": "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ, –≥–¥–µ —Ä–µ–ª–∏–≥–∏—è –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –≤–ª–∞—Å—Ç–∏ (—Å—Ç. 14).",
    "—Å–≤–æ–±–æ–¥–∞": "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é (—Å–≤–æ–±–æ–¥–∞ —Å–ª–æ–≤–∞, —Å–æ–≤–µ—Å—Ç–∏, –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è) (–ì–ª–∞–≤–∞ 2).",
    "—Å–µ–º—å—è": "–°–æ—é–∑ –ª—é–¥–µ–π, –Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (—Å—Ç. 38).",
    "—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": "–ü—Ä–∞–≤–æ –≤–ª–∞–¥–µ—Ç—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ —Ä–∞—Å–ø–æ—Ä—è–∂–∞—Ç—å—Å—è –∏–º—É—â–µ—Å—Ç–≤–æ–º (—á–∞—Å—Ç–Ω–∞—è, –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è, –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–∞—è) (—Å—Ç. 8, 35).",
    "—Å–æ–±—Ä–∞–Ω–∏–µ": "–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –°–æ–±—Ä–∞–Ω–∏–µ ‚Äî –ø–∞—Ä–ª–∞–º–µ–Ω—Ç –†–§ (—Å—Ç. 94). –¢–∞–∫–∂–µ –ø—Ä–∞–≤–æ —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –º–∏—Ä–Ω–æ (—Å—Ç. 31).",
    "—Å–æ–≤–µ—Ç —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏": "–í–µ—Ä—Ö–Ω—è—è –ø–∞–ª–∞—Ç–∞ –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞ –†–§ (—Å—Ç. 95).",
    "—Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ": "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ, –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –¥–æ—Å—Ç–æ–π–Ω—É—é –∂–∏–∑–Ω—å –≥—Ä–∞–∂–¥–∞–Ω (—Å—Ç. 7).",
    "—Å—É–≤–µ—Ä–µ–Ω–∏—Ç–µ—Ç": "–í–µ—Ä—Ö–æ–≤–µ–Ω—Å—Ç–≤–æ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤–ª–∞—Å—Ç–∏ (—Å—Ç. 4).",
    "—Å—É–¥": "–û—Ä–≥–∞–Ω, –æ—Å—É—â–µ—Å—Ç–≤–ª—è—é—â–∏–π –ø—Ä–∞–≤–æ—Å—É–¥–∏–µ (—Å—Ç. 118).",
    "—Å—É–¥—å—è": "–õ–∏—Ü–æ, –Ω–∞–¥–µ–ª–µ–Ω–Ω–æ–µ –ø–æ–ª–Ω–æ–º–æ—á–∏—è–º–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –ø—Ä–∞–≤–æ—Å—É–¥–∏–µ. –°—É–¥—å–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –∏ –ø–æ–¥—á–∏–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–∫–æ–Ω—É (—Å—Ç. 120).",
    "—Ç–∞–º–æ–∂–Ω—è": "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ä–≥–∞–Ω, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≥—Ä–∞–Ω–∏—Ü—É (—Å—Ç. 74 - —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã).",
    "—Ç—Ä—É–¥": "–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫–∞. –¢—Ä—É–¥ —Å–≤–æ–±–æ–¥–µ–Ω, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä—É–¥ –∑–∞–ø—Ä–µ—â–µ–Ω (—Å—Ç. 37).",
    "—É–∫–∞–∑": "–ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∞–∫—Ç, –∏–∑–¥–∞–≤–∞–µ–º—ã–π –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º –†–§ (—Å—Ç. 90).",
    "—Ñ–µ–¥–µ—Ä–∞—Ü–∏—è": "–§–æ—Ä–º–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –†–§ (—Å—Ç. 1, 5).",
    "—ç–∫–æ–ª–æ–≥–∏—è": "–í–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥–æ–π. –ö–∞–∂–¥—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—É—é –æ–∫—Ä—É–∂–∞—é—â—É—é —Å—Ä–µ–¥—É (—Å—Ç. 42)."
};

const MARKERS = {
    federal: ['—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ', '—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π', '—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ', '–æ—Å–Ω–æ–≤—ã', '—Å—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', '–ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞', '–∞–º–Ω–∏—Å—Ç–∏—è', '–ø–æ–º–∏–ª–æ–≤–∞–Ω–∏–µ', '–æ–±–æ—Ä–æ–Ω–∞', '–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–≤–∞–ª—é—Ç–Ω–æ–µ', '–∫—Ä–µ–¥–∏—Ç–Ω–æ–µ', '—Ç–∞–º–æ–∂–µ–Ω–Ω–æ–µ', '–¥–µ–Ω–µ–∂–Ω–∞—è —ç–º–∏—Å—Å–∏—è', '—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã', '–º–µ—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è', '–≥–µ–æ–¥–µ–∑–∏—è', '–∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—è', '–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã'],
    joint: ['—Å–æ–≤–º–µ—Å—Ç–Ω–æ–º', '–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ', '–∑–∞—â–∏—Ç–∞', '–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è', '–æ—Ö—Ä–∞–Ω–∞', '–æ–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã', '–æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã', '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ', '—Ç—Ä—É–¥–æ–≤–æ–µ', '—Å–µ–º–µ–π–Ω–æ–µ', '–∂–∏–ª–∏—â–Ω–æ–µ', '–∞–¥–≤–æ–∫–∞—Ç—É—Ä–∞', '–Ω–æ—Ç–∞—Ä–∏–∞—Ç', '–∫–∞–¥—Ä—ã']
};

/* --- –î–ê–ù–ù–´–ï –î–õ–Ø –ö–ê–†–¢–´ --- */
const FEDERAL_DISTRICTS = {
    "reg-cen": {
        title: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –§–û",
        list: "–ú–æ—Å–∫–≤–∞, –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
    },
    "reg-nw": {
        title: "–°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω—ã–π –§–û",
        list: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏, –ù–µ–Ω–µ—Ü–∫–∏–π –ê–û"
    },
    "reg-south": {
        title: "–Æ–∂–Ω—ã–π –§–û",
        list: "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, –ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö—Ä—ã–º, –°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"
    },
    "reg-kav": {
        title: "–°–µ–≤–µ—Ä–æ-–ö–∞–≤–∫–∞–∑—Å–∫–∏–π –§–û",
        list: "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è, –ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞, –ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞, –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è ‚Äî –ê–ª–∞–Ω–∏—è, –ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞"
    },
    "reg-vol": {
        title: "–ü—Ä–∏–≤–æ–ª–∂—Å–∫–∏–π –§–û",
        list: "–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω, –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω, –ß—É–≤–∞—à–∏—è, –ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π, –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ú–∞—Ä–∏–π –≠–ª, –ú–æ—Ä–¥–æ–≤–∏—è, –£–¥–º—É—Ä—Ç–∏—è"
    },
    "reg-ural": {
        title: "–£—Ä–∞–ª—å—Å–∫–∏–π –§–û",
        list: "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û, –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û"
    },
    "reg-sib": {
        title: "–°–∏–±–∏—Ä—Å–∫–∏–π –§–û",
        list: "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π, –ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π, –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π, –¢—ã–≤–∞, –•–∞–∫–∞—Å–∏—è"
    },
    "reg-fe": {
        title: "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–π –§–û",
        list: "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π, –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π, –ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –Ø–∫—É—Ç–∏—è, –ë—É—Ä—è—Ç–∏—è, –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π, –ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û, –ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û, –ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π"
    }
};

/* --- –ò–ì–†–ê ‚Ññ13 (–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ë–ê–ó–ê) --- */
const POWERS = [
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ–≤ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º—ã", target: "president" },
    { text: "–†–æ—Å–ø—É—Å–∫ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º—ã", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ–Ω–¥—É–º–∞", target: "president" },
    { text: "–í–Ω–µ—Å–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—É—é –î—É–º—É", target: "president" },
    { text: "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∏ –æ–±–Ω–∞—Ä–æ–¥–æ–≤–∞–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–≤", target: "president" },
    { text: "–ï–∂–µ–≥–æ–¥–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–º—É –°–æ–±—Ä–∞–Ω–∏—é", target: "president" },
    { text: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –ø–æ–º–∏–ª–æ–≤–∞–Ω–∏—è", target: "president" },
    { text: "–†–µ—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–∞ –†–§", target: "president" },
    { text: "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–±–µ–∂–∏—â–∞", target: "president" },
    { text: "–ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –Ω–∞–≥—Ä–∞–¥–∞–º–∏", target: "president" },
    { text: "–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –ø–æ—á–µ—Ç–Ω—ã—Ö –∑–≤–∞–Ω–∏–π", target: "president" },
    { text: "–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –≤—ã—Å—à–∏—Ö –≤–æ–∏–Ω—Å–∫–∏—Ö –∑–≤–∞–Ω–∏–π", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§ (—Å —Å–æ–≥–ª–∞—Å–∏—è –ì–î)", target: "president" },
    { text: "–ü—Ä–∏–Ω—è—Ç–∏–µ –æ—Ç—Å—Ç–∞–≤–∫–∏ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏—Å—Ç—Ä–æ–≤", target: "president" },
    { text: "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –≤–Ω–µ—à–Ω–µ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π –†–§", target: "president" },
    { text: "–í–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–æ–≤ (–ø–æ—Å–ª–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π —Å –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–æ–º)", target: "president" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω–æ–π –¥–æ–∫—Ç—Ä–∏–Ω—ã", target: "president" },
    { text: "–Ø–≤–ª—è–µ—Ç—Å—è –í–µ—Ä—Ö–æ–≤–Ω—ã–º –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥—É—é—â–∏–º", target: "president" },
    { text: "–í–≤–µ–¥–µ–Ω–∏–µ –≤–æ–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è", target: "president" },
    { text: "–í–≤–µ–¥–µ–Ω–∏–µ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—É–¥–µ–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—É–¥–æ–≤ (–∫—Ä–æ–º–µ –≤—ã—Å—à–∏—Ö)", target: "president" },
    { text: "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –°–æ–≤–µ—Ç—É –§–µ–¥–µ—Ä–∞—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä —Å—É–¥–µ–π –≤—ã—Å—à–∏—Ö —Å—É–¥–æ–≤", target: "president" },
    { text: "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –°–æ–≤–µ—Ç—É –§–µ–¥–µ—Ä–∞—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä—ã –ì–µ–Ω–ø—Ä–æ–∫—É—Ä–æ—Ä–∞", target: "president" },
    { text: "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –°–æ–≤–µ—Ç–∞", target: "president" },
    { text: "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –°–æ–≤–µ—Ç–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", target: "president" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞", target: "president" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –º–µ–∂–¥—É —Å—É–±—ä–µ–∫—Ç–∞–º–∏ –†–§", target: "sf" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–∫–∞–∑–∞ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –æ –≤–≤–µ–¥–µ–Ω–∏–∏ –≤–æ–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è", target: "sf" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–∫–∞–∑–∞ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –æ –≤–≤–µ–¥–µ–Ω–∏–∏ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è", target: "sf" },
    { text: "–†–µ—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –í–° –†–§ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ–≤ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –†–§", target: "sf" },
    { text: "–û—Ç—Ä–µ—à–µ–Ω–∏–µ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –†–§ –æ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—É–¥–µ–π –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω–æ–≥–æ –°—É–¥–∞ –†–§", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—É–¥–µ–π –í–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –°—É–¥–∞ –†–§", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∫—É—Ä–æ—Ä–∞ –†–§ (–ø–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞)", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–π –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∫—É—Ä–æ—Ä–∞", target: "sf" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –°—á–µ—Ç–Ω–æ–π –ø–∞–ª–∞—Ç—ã", target: "sf" },
    { text: "–î–∞—á–∞ —Å–æ–≥–ª–∞—Å–∏—è –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç—É –Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞", target: "gd" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª–µ–π –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞", target: "gd" },
    { text: "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏—Å—Ç—Ä–æ–≤ (–Ω–µ —Å–∏–ª–æ–≤—ã—Ö)", target: "gd" },
    { text: "–†–µ—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –æ –¥–æ–≤–µ—Ä–∏–∏ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤—É –†–§", target: "gd" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –†–§", target: "gd" },
    { text: "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞", target: "gd" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—è –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –°—á–µ—Ç–Ω–æ–π –ø–∞–ª–∞—Ç—ã", target: "gd" },
    { text: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –£–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω–æ–≥–æ –ø–æ –ø—Ä–∞–≤–∞–º —á–µ–ª–æ–≤–µ–∫–∞", target: "gd" },
    { text: "–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∞–º–Ω–∏—Å—Ç–∏–∏", target: "gd" },
    { text: "–í—ã–¥–≤–∏–∂–µ–Ω–∏–µ –æ–±–≤–∏–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–∏–≤ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –†–§", target: "gd" },
    { text: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞", target: "gov" },
    { text: "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º–µ", target: "gov" },
    { text: "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç–∞", target: "gov" },
    { text: "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ–± –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞", target: "gov" },
    { text: "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –µ–¥–∏–Ω–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏", target: "gov" },
    { text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∫—É–ª—å—Ç—É—Ä—ã", target: "gov" },
    { text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞—É–∫–∏ –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è", target: "gov" },
    { text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", target: "gov" },
    { text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è", target: "gov" },
    { text: "–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ —ç–∫–æ–ª–æ–≥–∏–∏", target: "gov" },
    { text: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é", target: "gov" },
    { text: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –º–µ—Ä –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –æ–±–æ—Ä–æ–Ω—ã —Å—Ç—Ä–∞–Ω—ã", target: "gov" },
    { text: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –º–µ—Ä –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", target: "gov" },
    { text: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ–±—Ä–æ–≤–æ–ª—å—á–µ—Å–∫–æ–π (–≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–æ–π) –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", target: "gov" },
    { text: "–°–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑–≤–∏—Ç–∏—é –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞", target: "gov" }
];

const game = { score: 0, currentQuestion: null, isBusy: false };

function initGame() {
    safeAddListener('#gameBtn', 'click', () => {
        const hs = $('#highScore');
        if (hs) hs.textContent = localStorage.getItem(LS.HIGHSCORE) || 0;
        const start = $('#gameStartScreen');
        const play = $('#gamePlayScreen');
        if (start) start.hidden = false;
        if (play) play.hidden = true;
        const dlg = $('#gameDialog');
        if (dlg) dlg.showModal();
    });

    safeAddListener('#closeGame', 'click', () => $('#gameDialog').close());
    safeAddListener('#startGameBtn', 'click', () => {
        game.score = 0;
        updateGameScore();
        $('#gameStartScreen').hidden = true;
        $('#gamePlayScreen').hidden = false;
        nextQuestion();
    });

    $$('.ans-btn').forEach(btn => btn.addEventListener('click', (e) => checkAnswer(e.target)));
}

function nextQuestion() {
    game.isBusy = false;
    const randomIndex = Math.floor(Math.random() * POWERS.length);
    game.currentQuestion = POWERS[randomIndex];
    const qText = $('#questionText');
    if (qText) {
        qText.style.opacity = 0;
        setTimeout(() => { qText.textContent = game.currentQuestion.text; qText.style.opacity = 1; }, 200);
    }
    $$('.ans-btn').forEach(btn => btn.className = 'ans-btn');
    const fb = $('#gameFeedback');
    if (fb) fb.textContent = "";
}

function checkAnswer(btn) {
    if (game.isBusy) return;
    game.isBusy = true;
    const target = btn.dataset.target;
    const isCorrect = target === game.currentQuestion.target;
    const fb = $('#gameFeedback');

    if (isCorrect) {
        btn.classList.add('correct');
        game.score++;
        if (fb) { fb.textContent = "–í–µ—Ä–Ω–æ! üéâ"; fb.style.color = "#22c55e"; }
    } else {
        btn.classList.add('wrong');
        const correctBtn = $(`.ans-btn[data-target="${game.currentQuestion.target}"]`);
        if (correctBtn) correctBtn.classList.add('correct');
        if (fb) { fb.textContent = "–û—à–∏–±–∫–∞ üòî"; fb.style.color = "#ef4444"; }
    }
    updateGameScore();
    const currentHigh = parseInt(localStorage.getItem(LS.HIGHSCORE) || 0);
    if (game.score > currentHigh) localStorage.setItem(LS.HIGHSCORE, game.score);
    setTimeout(nextQuestion, 1500);
}

function updateGameScore() {
    const sc = $('#currentScore');
    if (sc) sc.textContent = game.score;
}

/* --- –ó–ê–î–ê–ù–ò–ï ‚Ññ23 (–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ë–ê–ó–ê) --- */
const TASKS_23 = [
    {
        question: "–†–§ ‚Äî —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è –ª—é–¥–µ–π", correct: true },
            { id: 2, text: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ú–†–û–¢", correct: true },
            { id: 3, text: "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–µ–º—å–∏, –º–∞—Ç–µ—Ä–∏–Ω—Å—Ç–≤–∞, –æ—Ç—Ü–æ–≤—Å—Ç–≤–∞ –∏ –¥–µ—Ç—Å—Ç–≤–∞", correct: true },
            { id: 4, text: "–†–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É–∂–±", correct: true },
            { id: 5, text: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ–Ω—Å–∏–π –∏ –ø–æ—Å–æ–±–∏–π", correct: true },
            { id: 6, text: "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–ª–∞—Å—Ç–∏ –Ω–∞ —Ç—Ä–∏ –≤–µ—Ç–≤–∏", correct: false },
            { id: 7, text: "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –∏–¥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî —Å–≤–µ—Ç—Å–∫–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–ù–∏–∫–∞–∫–∞—è —Ä–µ–ª–∏–≥–∏—è –Ω–µ –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∏–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π", correct: true },
            { id: 2, text: "–†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç–¥–µ–ª–µ–Ω—ã –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞", correct: true },
            { id: 3, text: "–†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–≤–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–∫–æ–Ω–æ–º", correct: true },
            { id: 4, text: "–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–≤–æ–±–æ–¥—ã —Å–æ–≤–µ—Å—Ç–∏ –∏ –≤–µ—Ä–æ–∏—Å–ø–æ–≤–µ–¥–∞–Ω–∏—è", correct: true },
            { id: 5, text: "–ö–∞–∂–¥—ã–π –≤–ø—Ä–∞–≤–µ –∏—Å–ø–æ–≤–µ–¥–æ–≤–∞—Ç—å –ª—é–±—É—é —Ä–µ–ª–∏–≥–∏—é –∏–ª–∏ –Ω–µ –∏—Å–ø–æ–≤–µ–¥–æ–≤–∞—Ç—å –Ω–∏–∫–∞–∫–æ–π", correct: true },
            { id: 6, text: "–ó–µ–º–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–∞ –∂–∏–∑–Ω–∏ –Ω–∞—Ä–æ–¥–æ–≤", correct: false },
            { id: 7, text: "–í–æ –≤–∑–∞–∏–º–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º–∏ –æ—Ä–≥–∞–Ω–∞–º–∏ –≤—Å–µ —Å—É–±—ä–µ–∫—Ç—ã —Ä–∞–≤–Ω–æ–ø—Ä–∞–≤–Ω—ã", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî –¥–µ–º–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–ù–æ—Å–∏—Ç–µ–ª–µ–º —Å—É–≤–µ—Ä–µ–Ω–∏—Ç–µ—Ç–∞ –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –≤–ª–∞—Å—Ç–∏ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—Ä–æ–¥", correct: true },
            { id: 2, text: "–ù–∞—Ä–æ–¥ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç —Å–≤–æ—é –≤–ª–∞—Å—Ç—å –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ, –∞ —Ç–∞–∫–∂–µ —á–µ—Ä–µ–∑ –æ—Ä–≥–∞–Ω—ã –≤–ª–∞—Å—Ç–∏", correct: true },
            { id: 3, text: "–í—ã—Å—à–∏–º –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º –≤–ª–∞—Å—Ç–∏ –Ω–∞—Ä–æ–¥–∞ —è–≤–ª—è—é—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ–Ω–¥—É–º –∏ –≤—ã–±–æ—Ä—ã", correct: true },
            { id: 4, text: "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è –∏ –º–Ω–æ–≥–æ–ø–∞—Ä—Ç–∏–π–Ω–æ—Å—Ç–∏", correct: true },
            { id: 5, text: "–ú–µ—Å—Ç–Ω–æ–µ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–∏—Ö –ø–æ–ª–Ω–æ–º–æ—á–∏–π —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ", correct: true },
            { id: 6, text: "–û—Ç–¥–µ–ª–µ–Ω–∏–µ —Ü–µ—Ä–∫–≤–∏ –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞", correct: false },
            { id: 7, text: "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–æ–≤ –∏ –ø–æ–∂–∏–ª—ã—Ö –≥—Ä–∞–∂–¥–∞–Ω", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî –ø—Ä–∞–≤–æ–≤–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–í–µ—Ä—Ö–æ–≤–µ–Ω—Å—Ç–≤–æ –∑–∞–∫–æ–Ω–∞ –∏ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏", correct: true },
            { id: 2, text: "–ß–µ–ª–æ–≤–µ–∫, –µ–≥–æ –ø—Ä–∞–≤–∞ –∏ —Å–≤–æ–±–æ–¥—ã —è–≤–ª—è—é—Ç—Å—è –≤—ã—Å—à–µ–π —Ü–µ–Ω–Ω–æ—Å—Ç—å—é", correct: true },
            { id: 3, text: "–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å, —Å–æ–±–ª—é–¥–∞—Ç—å –∏ –∑–∞—â–∏—â–∞—Ç—å –ø—Ä–∞–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞", correct: true },
            { id: 4, text: "–í—Å–µ —Ä–∞–≤–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–∫–æ–Ω–æ–º –∏ —Å—É–¥–æ–º", correct: true },
            { id: 5, text: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∏ —Å–≤–æ–±–æ–¥ –Ω–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∞ –¥—Ä—É–≥–∏—Ö –ª–∏—Ü", correct: true },
            { id: 6, text: "–ù–∞–ª–∏—á–∏–µ –µ–¥–∏–Ω–æ–π –¥–µ–Ω–µ–∂–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã", correct: false },
            { id: 7, text: "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ–Ω—Å–∏–π", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî —Ñ–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–°–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ä–µ—Å–ø—É–±–ª–∏–∫, –∫—Ä–∞–µ–≤, –æ–±–ª–∞—Å—Ç–µ–π, –≥–æ—Ä–æ–¥–æ–≤ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è", correct: true },
            { id: 2, text: "–†–∞–≤–Ω–æ–ø—Ä–∞–≤–∏–µ —Å—É–±—ä–µ–∫—Ç–æ–≤ –†–§", correct: true },
            { id: 3, text: "–†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤–µ–¥–µ–Ω–∏—è –º–µ–∂–¥—É –†–§ –∏ —Å—É–±—ä–µ–∫—Ç–∞–º–∏", correct: true },
            { id: 4, text: "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å", correct: true },
            { id: 5, text: "–ï–¥–∏–Ω—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–ª–∞—Å—Ç–∏", correct: true },
            { id: 6, text: "–ù–∏–∫–∞–∫–∞—è —Ä–µ–ª–∏–≥–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π", correct: false },
            { id: 7, text: "–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è –ª—é–¥–µ–π", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî —Ä–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –ø—Ä–∞–≤–ª–µ–Ω–∏—è",
        options: [
            { id: 1, text: "–ì–ª–∞–≤–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç) –∏–∑–±–∏—Ä–∞–µ—Ç—Å—è —Å—Ä–æ–∫–æ–º –Ω–∞ 6 –ª–µ—Ç", correct: true },
            { id: 2, text: "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –î—É–º–∞ –∏–∑–±–∏—Ä–∞–µ—Ç—Å—è —Å—Ä–æ–∫–æ–º –Ω–∞ 5 –ª–µ—Ç", correct: true },
            { id: 3, text: "–í—ã—Å—à–∏–µ –æ—Ä–≥–∞–Ω—ã –≤–ª–∞—Å—Ç–∏ —è–≤–ª—è—é—Ç—Å—è –≤—ã–±–æ—Ä–Ω—ã–º–∏ –∏ —Å–º–µ–Ω—è–µ–º—ã–º–∏", correct: true },
            { id: 4, text: "–ì–ª–∞–≤—ã —Å—É–±—ä–µ–∫—Ç–æ–≤ –§–µ–¥–µ—Ä–∞—Ü–∏–∏ –∏–∑–±–∏—Ä–∞—é—Ç—Å—è", correct: true },
            { id: 5, text: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–æ—Å—É–¥–∏—è —Ç–æ–ª—å–∫–æ —Å—É–¥–æ–º", correct: false },
            { id: 6, text: "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –∏–¥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è", correct: false }
        ]
    },
    {
        question: "–†–§ ‚Äî —Å—É–≤–µ—Ä–µ–Ω–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
        options: [
            { id: 1, text: "–°—É–≤–µ—Ä–µ–Ω–∏—Ç–µ—Ç –†–§ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –≤—Å—é –µ—ë —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é", correct: true },
            { id: 2, text: "–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –†–§ –∏ –∑–∞–∫–æ–Ω—ã –∏–º–µ—é—Ç –≤–µ—Ä—Ö–æ–≤–µ–Ω—Å—Ç–≤–æ –Ω–∞ –≤—Å–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏", correct: true },
            { id: 3, text: "–†–§ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏ –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç—å —Å–≤–æ–µ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏", correct: true },
            { id: 4, text: "–ó–∞–ø—Ä–µ—Ç –Ω–∞ –æ—Ç—á—É–∂–¥–µ–Ω–∏–µ —á–∞—Å—Ç–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –†–§", correct: true },
            { id: 5, text: "–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞ –∏ –∑–¥–æ—Ä–æ–≤—å—è", correct: false },
            { id: 6, text: "–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–≤–æ–±–æ–¥—ã —Å–æ–≤–µ—Å—Ç–∏", correct: false }
        ]
    },
    {
        question: "–ï–¥–∏–Ω—Å—Ç–≤–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞",
        options: [
            { id: 1, text: "–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤, —É—Å–ª—É–≥ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤", correct: true },
            { id: 2, text: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏", correct: true },
            { id: 3, text: "–°–≤–æ–±–æ–¥–∞ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", correct: true },
            { id: 4, text: "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞ —Ä–∞–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —á–∞—Å—Ç–Ω–æ–π, –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π, –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏", correct: true },
            { id: 5, text: "–ó–∞–ø—Ä–µ—Ç –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã", correct: true },
            { id: 6, text: "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≤–ª–∞—Å—Ç–µ–π –Ω–∞ —Ç—Ä–∏ –≤–µ—Ç–≤–∏", correct: false },
            { id: 7, text: "–°–≤–µ—Ç—Å–∫–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞", correct: false }
        ]
    },
    {
        question: "–ò–¥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏–µ",
        options: [
            { id: 1, text: "–ù–∏–∫–∞–∫–∞—è –∏–¥–µ–æ–ª–æ–≥–∏—è –Ω–µ –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π", correct: true },
            { id: 2, text: "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏—è –∏ –º–Ω–æ–≥–æ–ø–∞—Ä—Ç–∏–π–Ω–æ—Å—Ç–∏", correct: true },
            { id: 3, text: "–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–≤–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–∫–æ–Ω–æ–º", correct: true },
            { id: 4, text: "–°–≤–æ–±–æ–¥–∞ –º—ã—Å–ª–∏ –∏ —Å–ª–æ–≤–∞", correct: true },
            { id: 5, text: "–ó–∞–ø—Ä–µ—Ç —Ü–µ–Ω–∑—É—Ä—ã", correct: true },
            { id: 6, text: "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–µ–º—å–∏", correct: false },
            { id: 7, text: "–ï–¥–∏–Ω—Å—Ç–≤–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞", correct: false }
        ]
    },
    {
        question: "–ì–∞—Ä–∞–Ω—Ç–∏—è –ø—Ä–µ–∑—É–º–ø—Ü–∏–∏ –Ω–µ–≤–∏–Ω–æ–≤–Ω–æ—Å—Ç–∏",
        options: [
            { id: 1, text: "–ö–∞–∂–¥—ã–π –æ–±–≤–∏–Ω—è–µ–º—ã–π —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–≤–∏–Ω–æ–≤–Ω—ã–º, –ø–æ–∫–∞ –µ–≥–æ –≤–∏–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –¥–æ–∫–∞–∑–∞–Ω–∞", correct: true },
            { id: 2, text: "–û–±–≤–∏–Ω—è–µ–º—ã–π –Ω–µ –æ–±—è–∑–∞–Ω –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ—é –Ω–µ–≤–∏–Ω–æ–≤–Ω–æ—Å—Ç—å", correct: true },
            { id: 3, text: "–ù–µ—É—Å—Ç—Ä–∞–Ω–∏–º—ã–µ —Å–æ–º–Ω–µ–Ω–∏—è –≤ –≤–∏–Ω–æ–≤–Ω–æ—Å—Ç–∏ —Ç–æ–ª–∫—É—é—Ç—Å—è –≤ –ø–æ–ª—å–∑—É –æ–±–≤–∏–Ω—è–µ–º–æ–≥–æ", correct: true },
            { id: 4, text: "–ù–∏–∫—Ç–æ –Ω–µ –æ–±—è–∑–∞–Ω —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ —Å–∞–º–æ–≥–æ —Å–µ–±—è", correct: true },
            { id: 5, text: "–°–≤–æ–±–æ–¥–∞ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è", correct: false },
            { id: 6, text: "–ü—Ä–∞–≤–æ –Ω–∞ –æ—Ö—Ä–∞–Ω—É –∑–¥–æ—Ä–æ–≤—å—è", correct: false }
        ]
    },
    {
        question: "–ì–∞—Ä–∞–Ω—Ç–∏—è –ª–∏—á–Ω—ã—Ö (–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏—Ö) –ø—Ä–∞–≤",
        options: [
            { id: 1, text: "–ü—Ä–∞–≤–æ –Ω–∞ –∂–∏–∑–Ω—å", correct: true },
            { id: 2, text: "–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ –ª–∏—á–Ω–æ—Å—Ç–∏ –æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º", correct: true },
            { id: 3, text: "–ü—Ä–∞–≤–æ –Ω–∞ —Å–≤–æ–±–æ–¥—É –∏ –ª–∏—á–Ω—É—é –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç—å", correct: true },
            { id: 4, text: "–ù–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç—å –∂–∏–ª–∏—â–∞", correct: true },
            { id: 5, text: "–¢–∞–π–Ω–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤", correct: true },
            { id: 6, text: "–ü—Ä–∞–≤–æ –∏–∑–±–∏—Ä–∞—Ç—å –∏ –±—ã—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–º", correct: false },
            { id: 7, text: "–ü—Ä–∞–≤–æ –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–µ–ª–∞–º–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞", correct: false }
        ]
    },
    {
        question: "–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤",
        options: [
            { id: 1, text: "–ü—Ä–∞–≤–æ –∏–∑–±–∏—Ä–∞—Ç—å –∏ –±—ã—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–º", correct: true },
            { id: 2, text: "–ü—Ä–∞–≤–æ –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–µ–ª–∞–º–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞", correct: true },
            { id: 3, text: "–†–∞–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–ª—É–∂–±–µ", correct: true },
            { id: 4, text: "–ü—Ä–∞–≤–æ —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –º–∏—Ä–Ω–æ, –±–µ–∑ –æ—Ä—É–∂–∏—è (–º–∏—Ç–∏–Ω–≥–∏)", correct: true },
            { id: 5, text: "–ü—Ä–∞–≤–æ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ—Å–æ—é–∑–æ–≤, –ø–∞—Ä—Ç–∏–π)", correct: true },
            { id: 6, text: "–ü—Ä–∞–≤–æ –Ω–∞ –æ—Ö—Ä–∞–Ω—É –∑–¥–æ—Ä–æ–≤—å—è", correct: false },
            { id: 7, text: "–ü—Ä–∞–≤–æ –Ω–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—É—é –æ–∫—Ä—É–∂–∞—é—â—É—é —Å—Ä–µ–¥—É", correct: false }
        ]
    },
    {
        question: "–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤",
        options: [
            { id: 1, text: "–°–≤–æ–±–æ–¥–∞ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", correct: true },
            { id: 2, text: "–ü—Ä–∞–≤–æ —á–∞—Å—Ç–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏", correct: true },
            { id: 3, text: "–°–≤–æ–±–æ–¥–∞ —Ç—Ä—É–¥–∞", correct: true },
            { id: 4, text: "–ü—Ä–∞–≤–æ –Ω–∞ –æ—Ç–¥—ã—Ö", correct: true },
            { id: 5, text: "–ü—Ä–∞–≤–æ –Ω–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É", correct: true },
            { id: 6, text: "–ü—Ä–∞–≤–æ –Ω–∞ –∂–∏–ª–∏—â–µ", correct: true },
            { id: 7, text: "–ü—Ä–∞–≤–æ –Ω–∞ –∂–∏–∑–Ω—å", correct: false }
        ]
    },
    {
        question: "–ì–∞—Ä–∞–Ω—Ç–∏—è –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∞–≤",
        options: [
            { id: 1, text: "–°–≤–æ–±–æ–¥–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏ –Ω–∞—É—á–Ω–æ–≥–æ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞", correct: true },
            { id: 2, text: "–ü—Ä–∞–≤–æ –Ω–∞ —É—á–∞—Å—Ç–∏–µ –≤ –∫—É–ª—å—Ç—É—Ä–Ω–æ–π –∂–∏–∑–Ω–∏", correct: true },
            { id: 3, text: "–ü—Ä–∞–≤–æ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ –∫—É–ª—å—Ç—É—Ä—ã", correct: true },
            { id: 4, text: "–î–æ—Å—Ç—É–ø –∫ –∫—É–ª—å—Ç—É—Ä–Ω—ã–º —Ü–µ–Ω–Ω–æ—Å—Ç—è–º", correct: true },
            { id: 5, text: "–û—Ö—Ä–∞–Ω–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏", correct: true },
            { id: 6, text: "–ü—Ä–∞–≤–æ –Ω–∞ —Å—É–¥–µ–±–Ω—É—é –∑–∞—â–∏—Ç—É", correct: false },
            { id: 7, text: "–ù–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç—å —á–∞—Å—Ç–Ω–æ–π –∂–∏–∑–Ω–∏", correct: false }
        ]
    },
    {
        question: "–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞ –†–§",
        options: [
            { id: 1, text: "–°–æ–±–ª—é–¥–∞—Ç—å –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—é –∏ –∑–∞–∫–æ–Ω—ã", correct: true },
            { id: 2, text: "–ü–ª–∞—Ç–∏—Ç—å –∑–∞–∫–æ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–ª–æ–≥–∏ –∏ —Å–±–æ—Ä—ã", correct: true },
            { id: 3, text: "–°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏—Ä–æ–¥—É –∏ –æ–∫—Ä—É–∂–∞—é—â—É—é —Å—Ä–µ–¥—É", correct: true },
            { id: 4, text: "–ó–∞—â–∏—â–∞—Ç—å –û—Ç–µ—á–µ—Å—Ç–≤–æ", correct: true },
            { id: 5, text: "–ó–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è", correct: true },
            { id: 6, text: "–ó–∞–±–æ—Ç–∏—Ç—å—Å—è –æ –¥–µ—Ç—è—Ö –∏ –Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª—è—Ö", correct: true },
            { id: 7, text: "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –≤—ã–±–æ—Ä–∞—Ö", correct: false },
            { id: 8, text: "–í—Å—Ç—É–ø–∞—Ç—å –≤ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä—Ç–∏–∏", correct: false }
        ]
    }
];

const game23 = { currentTaskIndex: 0, selectedIds: new Set() };

function initGame23() {
    safeAddListener('#game23Btn', 'click', () => {
        game23.currentTaskIndex = 0;
        // –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞–¥–∞–Ω–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
        TASKS_23.sort(() => Math.random() - 0.5);
        renderTask23();
        $('#game23Dialog').showModal();
    });
    safeAddListener('#closeGame23', 'click', () => $('#game23Dialog').close());

    safeAddListener('#checkTask23Btn', 'click', checkTask23);
    safeAddListener('#nextTask23Btn', 'click', () => {
        game23.currentTaskIndex = (game23.currentTaskIndex + 1) % TASKS_23.length;
        renderTask23();
    });
}

function renderTask23() {
    const task = TASKS_23[game23.currentTaskIndex];
    game23.selectedIds.clear();

    $('#task23Question').textContent = task.question;
    const container = $('#task23Options');
    container.innerHTML = '';
    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    const shuffled = [...task.options].sort(() => Math.random() - 0.5);

    shuffled.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'task23-option';
        div.textContent = opt.text;
        div.dataset.id = opt.id;
        div.addEventListener('click', () => toggleOption23(div, opt.id));
        container.appendChild(div);
    });

    $('#checkTask23Btn').disabled = true;
    $('#checkTask23Btn').style.display = 'inline-block';
    $('#nextTask23Btn').style.display = 'none';
    $('#task23Feedback').textContent = '';
}

function toggleOption23(el, id) {
    if ($('#nextTask23Btn').style.display === 'inline-block') return;

    if (game23.selectedIds.has(id)) {
        game23.selectedIds.delete(id);
        el.classList.remove('selected');
    } else {
        if (game23.selectedIds.size < 3) {
            game23.selectedIds.add(id);
            el.classList.add('selected');
        }
    }
    $('#checkTask23Btn').disabled = game23.selectedIds.size !== 3;
}

function checkTask23() {
    const task = TASKS_23[game23.currentTaskIndex];
    const correctIds = new Set(task.options.filter(o => o.correct).map(o => o.id));
    let errors = 0;

    $$('.task23-option').forEach(el => {
        const id = parseInt(el.dataset.id);
        const isSelected = game23.selectedIds.has(id);
        const isCorrect = correctIds.has(id);

        if (isSelected && isCorrect) {
            el.classList.add('correct');
        } else if (isSelected && !isCorrect) {
            el.classList.add('wrong');
            errors++;
        } else if (!isSelected && isCorrect) {
            el.style.border = "2px dashed #22c55e";
        }
    });

    const fb = $('#task23Feedback');
    if (errors === 0 && game23.selectedIds.size === 3) {
        fb.textContent = "–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –≤–µ—Ä–Ω–æ. +3 –±–∞–ª–ª–∞";
        fb.style.color = "#22c55e";
    } else {
        fb.textContent = `–û—à–∏–±–æ–∫: ${errors}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø–æ–º–Ω–∏—Ç—å –≤–µ—Ä–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è.`;
        fb.style.color = "#ef4444";
    }

    $('#checkTask23Btn').style.display = 'none';
    $('#nextTask23Btn').style.display = 'inline-block';
}

/* --- FLASHCARDS --- */
const flashcards = {
    terms: [],
    index: 0
};

function initFlashcards() {
    safeAddListener('#flashcardsBtn', 'click', () => {
        flashcards.terms = Object.keys(DICTIONARY).sort(() => Math.random() - 0.5);
        flashcards.index = 0;
        renderFlashcard();
        $('#flashcardsDialog').showModal();
    });

    safeAddListener('#closeFlashcards', 'click', () => $('#flashcardsDialog').close());

    safeAddListener('#fcNext', 'click', () => {
        if (flashcards.index < flashcards.terms.length - 1) {
            $('#flashcard').classList.remove('flipped');
            setTimeout(() => {
                flashcards.index++;
                renderFlashcard();
            }, 300);
        }
    });

    safeAddListener('#fcPrev', 'click', () => {
        if (flashcards.index > 0) {
            $('#flashcard').classList.remove('flipped');
            setTimeout(() => {
                flashcards.index--;
                renderFlashcard();
            }, 300);
        }
    });

    safeAddListener('#flashcard', 'click', () => {
        $('#flashcard').classList.toggle('flipped');
    });
}

function renderFlashcard() {
    if (flashcards.terms.length === 0) return;
    const term = flashcards.terms[flashcards.index];

    $('#fcTerm').textContent = term.charAt(0).toUpperCase() + term.slice(1);
    $('#fcDef').textContent = DICTIONARY[term];
    $('#fcCounter').textContent = `${flashcards.index + 1} / ${flashcards.terms.length}`;

    $('#fcPrev').disabled = flashcards.index === 0;
    $('#fcNext').disabled = flashcards.index === flashcards.terms.length - 1;
}

/* --- –®–†–ò–§–¢–´ --- */
function initFontSettings() {
    const saved = JSON.parse(localStorage.getItem(LS.FONT));
    if (saved) {
        state.fontSize = saved.size;
        state.lineHeight = saved.height;
    }
    const savedType = localStorage.getItem(LS.FONT_TYPE);
    if (savedType) {
        if (savedType === 'serif') document.body.classList.add('serif-mode');
        const rb = $(`input[name="fontType"][value="${savedType}"]`);
        if (rb) rb.checked = true;
    }

    applyFontSettings();

    safeAddListener('#fontBtn', 'click', () => {
        const dlg = $('#fontSettingsDialog');
        if (dlg) dlg.open ? dlg.close() : dlg.show();
    });

    safeAddListener('#fontInc', 'click', () => changeFont(1));
    safeAddListener('#fontDec', 'click', () => changeFont(-1));
    safeAddListener('#lhInc', 'click', () => changeLH(0.1));
    safeAddListener('#lhDec', 'click', () => changeLH(-0.1));

    // Font Type Toggle
    $$('input[name="fontType"]').forEach(rb => {
        rb.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'serif') document.body.classList.add('serif-mode');
            else document.body.classList.remove('serif-mode');
            localStorage.setItem(LS.FONT_TYPE, val);
        });
    });
}

function changeFont(delta) {
    state.fontSize = Math.max(12, Math.min(24, state.fontSize + delta));
    applyFontSettings();
}

function changeLH(delta) {
    state.lineHeight = Math.max(1.2, Math.min(2.0, parseFloat((state.lineHeight + delta).toFixed(1))));
    applyFontSettings();
}

function applyFontSettings() {
    document.documentElement.style.setProperty('--font-size', state.fontSize + 'px');
    document.documentElement.style.setProperty('--line-height', state.lineHeight);
    localStorage.setItem(LS.FONT, JSON.stringify({ size: state.fontSize, height: state.lineHeight }));
}

/* --- –¢–ê–ô–ú–ï–† --- */
function initTimer() {
    const timerEl = $('#egeTimer');
    if (!timerEl) return;
    const examDate = new Date('2026-06-11T09:00:00');

    function update() {
        const now = new Date();
        const diff = examDate - now;
        if (diff <= 0) { timerEl.innerHTML = "–ï–ì–≠ —É–∂–µ –∏–¥–µ—Ç!"; return; }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        let txt = '–¥–Ω–µ–π';
        const lastDigit = days % 10;
        const lastTwo = days % 100;
        if (lastDigit === 1 && lastTwo !== 11) txt = '–¥–µ–Ω—å';
        else if ([2, 3, 4].includes(lastDigit) && ![12, 13, 14].includes(lastTwo)) txt = '–¥–Ω—è';
        timerEl.innerHTML = `–î–æ –ï–ì–≠ –ø–æ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏—é:<br><span>${days} ${txt}</span>`;
    }
    update();
    setInterval(update, 1000 * 60 * 60);
}

/* --- –ü–û–ò–°–ö --- */
function initSearchHistory() {
    const stored = localStorage.getItem(LS.SEARCH);
    if (stored) state.searchHistory = JSON.parse(stored);

    const input = $('#searchInput');
    const container = $('#searchHistory');
    if (!input || !container) return;

    input.addEventListener('focus', () => {
        if (state.searchHistory.length > 0 && input.value === '') {
            renderSearchHistory();
            container.hidden = false;
        }
    });

    const debouncedSearch = debounce((q) => {
        if (!q && state.searchHistory.length > 0) {
            renderSearchHistory();
            container.hidden = false;
        } else {
            container.hidden = true;
            filterArticles(q);
        }
    }, 300);

    input.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) container.hidden = true;
    });
}

function saveSearchQuery(query) {
    if (!query || query.length < 2) return;
    state.searchHistory = state.searchHistory.filter(q => q !== query);
    state.searchHistory.unshift(query);
    if (state.searchHistory.length > 5) state.searchHistory.pop();
    localStorage.setItem(LS.SEARCH, JSON.stringify(state.searchHistory));
}

function renderSearchHistory() {
    const container = $('#searchHistory');
    if (!container) return;
    container.innerHTML = '';
    state.searchHistory.forEach(q => {
        const item = document.createElement('div');
        item.className = 'search-history-item';
        item.textContent = q;
        item.addEventListener('click', () => {
            $('#searchInput').value = q;
            container.hidden = true;
            performSearch(q);
        });
        container.appendChild(item);
    });
}

function performSearch(query) {
    saveSearchQuery(query);
    filterArticles(query);
    $('#searchHistory').hidden = true;
}

function levenshtein(a, b) {
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    const matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
            }
        }
    }
    return matrix[b.length][a.length];
}

function filterArticles(query) {
    query = query.trim().toLowerCase();
    state.activeSearchQuery = query;

    if (!query) { renderArticles(state.articles); return; }

    const sourceList = state.showFavoritesOnly ? state.articles.filter(a => state.favorites.has(a.id)) : state.articles;

    // Fuzzy Filter Logic
    const filtered = sourceList.filter(a => {
        const t = a.title.toLowerCase();
        const body = a.bodyHTML.replace(/<[^>]+>/g, ' ').toLowerCase();

        if (t.includes(query) || body.includes(query)) return true;

        if (query.length > 3) {
            const titleWords = t.split(/\s+/);
            const bodyWords = body.split(/\s+/).slice(0, 100);

            const matchWord = (word) => {
                if (Math.abs(word.length - query.length) > 2) return false;
                const dist = levenshtein(word, query);
                return dist <= 2;
            };

            return titleWords.some(matchWord) || bodyWords.some(matchWord);
        }
        return false;
    });

    renderArticles(filtered);
}

function processText(text) {
    const articleRegex = /(—Å—Ç–∞—Ç—å(?:–µ–π|—è–º–∏|–µ|—é|—è|–∏)\s+)((?:[\d\.\,\s‚Äì-]+|(?:\([^\)]+\))|–∏)+)/gi;
    text = text.replace(articleRegex, (match, prefix, listContent) => {
        const linkedList = listContent.replace(/((?:—á–∞—Å—Ç—å|–ø—É–Ω–∫—Ç)\s+)?(\d+(?:\.\d+)?)/gi, (m, keyword, num) => {
            if (keyword) return m;
            const targetArt = state.articles.find(a => a.title.startsWith(`–°—Ç–∞—Ç—å—è ${num}`));
            if (targetArt) return `<a href="#${targetArt.id}" class="cross-link" data-target="${targetArt.id}">${num}</a>`;
            return num;
        });
        return prefix + linkedList;
    });

    for (let term in DICTIONARY) {
        const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${safeTerm}[–∞-—è]*)`, 'gi');
        text = text.replace(regex, (match) => {
            if (match.includes('<') || match.includes('>')) return match;
            return `<span class="term" data-term="${term}">${match}</span>`;
        });
    }

    if (state.markersMode) {
        const escapeReg = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        MARKERS.federal.forEach(word => {
            const regex = new RegExp(`(${escapeReg(word)})`, 'gi');
            text = text.replace(regex, '<span class="mark-fed">$1</span>');
        });
        MARKERS.joint.forEach(word => {
            const regex = new RegExp(`(${escapeReg(word)})`, 'gi');
            text = text.replace(regex, '<span class="mark-joint">$1</span>');
        });
    }
    return text;
}

/* --- FAV FOLDERS LOGIC --- */
function loadFavorites() {
    const stored = localStorage.getItem(LS.FAVORITES);
    if (stored) { state.favorites = new Set(JSON.parse(stored)); }

    const storedFolders = localStorage.getItem(LS.FAV_FOLDERS);
    if (storedFolders) { state.favFolders = JSON.parse(storedFolders); }

    const storedMap = localStorage.getItem(LS.ARTICLE_FOLDERS);
    if (storedMap) { state.articleFolders = JSON.parse(storedMap); }

    updateFavCount();
}

function toggleFavorite(id) {
    if (state.favorites.has(id)) {
        state.favorites.delete(id);
        delete state.articleFolders[id];
        saveFolders();
    } else {
        state.favorites.add(id);
        state.articleFolders[id] = 'General'; // Default
        saveFolders();
    }
    localStorage.setItem(LS.FAVORITES, JSON.stringify([...state.favorites]));
    updateFavCount();
    renderArticles();
}

function saveFolders() {
    localStorage.setItem(LS.FAV_FOLDERS, JSON.stringify(state.favFolders));
    localStorage.setItem(LS.ARTICLE_FOLDERS, JSON.stringify(state.articleFolders));
}

function updateFavCount() {
    const badge = $('#favCount');
    if (badge) badge.textContent = state.favorites.size;
}

function setFavFilterMode() {
    state.showFavoritesOnly = !state.showFavoritesOnly;
    const btn = $('#favFilterBtn');
    const folderUI = $('#favFoldersContainer');

    if (state.showFavoritesOnly) {
        btn.setAttribute('aria-pressed', 'true');
        btn.innerHTML = `‚≠ê –°–∫—Ä—ã—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="badge">${state.favorites.size}</span>`;
        folderUI.hidden = false;
        renderFolderSelect();
    } else {
        btn.setAttribute('aria-pressed', 'false');
        btn.innerHTML = `‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="badge">${state.favorites.size}</span>`;
        folderUI.hidden = true;
        state.currentFolderFilter = 'all'; // reset
    }

    const search = $('#searchInput');
    if (search) search.value = '';
    state.activeSearchQuery = '';
    renderArticles();
}

function renderFolderSelect() {
    const select = $('#folderSelectFilter');
    select.innerHTML = '<option value="all">–í—Å–µ –ø–∞–ø–∫–∏</option>';
    state.favFolders.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        if (f === state.currentFolderFilter) opt.selected = true;
        select.appendChild(opt);
    });
}

/* --- –ó–ê–ú–ï–¢–ö–ò --- */
function loadNotes() {
    const stored = localStorage.getItem(LS.NOTES);
    if (stored) state.notes = JSON.parse(stored);
}

function saveNote(id, text) {
    if (!text.trim()) delete state.notes[id];
    else state.notes[id] = text;
    localStorage.setItem(LS.NOTES, JSON.stringify(state.notes));
}

function applyTheme(init = false) {
    let t = localStorage.getItem(LS.THEME);
    if (!t && init) {
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        t = systemPrefersDark ? 'dark' : 'light';
    } else if (!t) { t = 'dark'; }
    document.documentElement.classList.toggle('light', t === 'light');
    if (!init) updateScrollState();
}

function toggleTheme() {
    const isLight = document.documentElement.classList.contains('light');
    const newTheme = isLight ? 'dark' : 'light';
    localStorage.setItem(LS.THEME, newTheme);
    applyTheme();
}

/* --- SCROLL & SPY LOGIC --- */
function updateScrollState() {
    const scrollTop = window.scrollY;
    const bar = $('#scrollProgress .bar');
    if (bar) {
        const docHeight = document.body.scrollHeight;
        const winHeight = window.innerHeight;
        const scrollPercent = scrollTop / (docHeight - winHeight);
        bar.style.width = Math.round(scrollPercent * 100) + '%';
    }
    const btnUp = $('#backToTop');
    if (btnUp) {
        if (scrollTop > 300) btnUp.classList.add('visible');
        else btnUp.classList.remove('visible');
    }
}

function initSpyScroll() {
    const toc = $('#toc');
    const checkActiveChapter = debounce(() => {
        if (!toc) return;
        const cards = $$('.card');
        if (cards.length === 0) return;

        const headerOffset = 100;
        let activeCard = null;

        for (let card of cards) {
            const rect = card.getBoundingClientRect();
            if (rect.bottom > headerOffset) {
                activeCard = card;
                break;
            }
        }

        if (!activeCard) return;

        const articleId = activeCard.dataset.articleId;
        const article = state.articles.find(a => a.id === articleId);

        if (article) {
            $$('.toc-chapter').forEach(el => el.classList.remove('active'));
            const chapters = $$('.toc-chapter');
            chapters.forEach(ch => {
                const titleSpan = ch.querySelector('.toc-chapter-header span:first-child');
                if (titleSpan && titleSpan.textContent === article.chapterTitle) {
                    ch.classList.add('active');
                }
            });
        }
    }, 100);

    window.addEventListener('scroll', checkActiveChapter);
}

function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
function showReturnButton() { const btn = $('#btn-return'); if (btn) btn.classList.add('visible'); }
function hideReturnButton() { const btn = $('#btn-return'); if (btn) btn.classList.remove('visible'); }

function returnBack() {
    if (state.returnPosition !== null) {
        state.isJumping = true;
        window.scrollTo({ top: state.returnPosition, behavior: 'smooth' });
        hideReturnButton();
        setTimeout(() => {
            state.isJumping = false;
            state.returnPosition = null;
            state.landingPosition = null;
        }, 1000);
    }
}

function buildTOC() {
    const nav = $('#toc');
    if (!nav) return;
    nav.innerHTML = '<div class="toc-title">–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</div><ul class="toc-list"></ul>';
    const ul = $('.toc-list', nav);

    const chapters = {};
    state.articles.forEach(a => {
        if (!chapters[a.chapterTitle]) chapters[a.chapterTitle] = [];
        chapters[a.chapterTitle].push(a);
    });

    Object.keys(chapters).forEach(chTitle => {
        const li = document.createElement('li');
        li.className = 'toc-chapter';
        const header = document.createElement('div');
        header.className = 'toc-chapter-header';
        header.innerHTML = `<span>${chTitle}</span><span class="toc-toggle-icon">‚ñº</span>`;
        header.addEventListener('click', () => { li.classList.toggle('open'); });

        const subUl = document.createElement('ul');
        subUl.className = 'toc-articles';
        chapters[chTitle].forEach(art => {
            const subLi = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = art.title;
            a.addEventListener('click', e => {
                e.preventDefault();
                if (state.showFavoritesOnly) setFavFilterMode();
                const el = document.getElementById(art.id);
                if (el) {
                    const offset = 80;
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = el.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    window.scrollTo({ top: elementPosition - offset, behavior: "smooth" });
                }
            });
            subLi.append(a);
            subUl.append(subLi);
        });
        li.append(header);
        li.append(subUl);
        ul.append(li);
    });
}

function renderArticles(list = state.articles) {
    const container = $('#content');
    if (!container) return;
    container.innerHTML = '';

    let displayList = list;
    if (state.showFavoritesOnly) {
        displayList = list.filter(a => state.favorites.has(a.id));
        // Filter by Folder
        if (state.currentFolderFilter !== 'all') {
            displayList = displayList.filter(a => state.articleFolders[a.id] === state.currentFolderFilter);
        }

        if (displayList.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted)">–í —ç—Ç–æ–π –ø–∞–ø–∫–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.</div>';
            return;
        }
    }

    if (displayList.length === 0 && state.activeSearchQuery) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
        return;
    }

    const template = $('#articleCardTmpl');

    displayList.forEach(a => {
        const node = template.content.cloneNode(true);
        const card = $('.card', node);
        card.dataset.articleId = a.id;
        card.id = a.id;

        // FOLDER UI
        const folderSelector = $('.fav-folder-selector', node);
        const cardFolderSelect = $('.card-folder-select', node);
        if (state.favorites.has(a.id)) {
            folderSelector.hidden = false;
            // Populate options
            cardFolderSelect.innerHTML = '';
            state.favFolders.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f;
                if (state.articleFolders[a.id] === f) opt.selected = true;
                cardFolderSelect.appendChild(opt);
            });
            // Change listener
            cardFolderSelect.addEventListener('change', (e) => {
                state.articleFolders[a.id] = e.target.value;
                saveFolders();
                if (state.showFavoritesOnly) renderArticles(); // re-render to apply filter
            });
        } else {
            folderSelector.hidden = true;
        }

        const crumbs = $('.breadcrumbs', node);
        const chShort = a.chapterTitle.split('.')[0] || a.chapterTitle;
        crumbs.textContent = `${chShort.trim()} > ${a.title}`;

        $('.title', node).textContent = a.title;

        let processedBody = processText(a.bodyHTML);
        if (state.activeSearchQuery && state.activeSearchQuery.length > 2) {
            const escaped = state.activeSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const re = new RegExp(`(${escaped})`, 'gi');
            processedBody = processedBody.replace(re, '<mark>$1</mark>');
        }
        $('.body', node).innerHTML = processedBody;

        const explain = $('.explain', node);
        let processedExplain = a.explainHTML ? processText(a.explainHTML) : '';
        let foundInExplain = false;

        if (a.explainHTML) {
            if (state.activeSearchQuery && state.activeSearchQuery.length > 2) {
                const escaped = state.activeSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const re = new RegExp(`(${escaped})`, 'gi');
                if (re.test(processedExplain)) foundInExplain = true;
                processedExplain = processedExplain.replace(re, '<mark>$1</mark>');
            }
            $('.explain-body', node).innerHTML = processedExplain;

            // ALWAYS VISIBLE (removed TeacherMode check)
            if (foundInExplain) { explain.open = true; }
        } else { explain.hidden = true; }

        const favBtn = $('.btn-fav', node);
        const isFav = state.favorites.has(a.id);
        favBtn.textContent = isFav ? '‚òÖ' : '‚òÜ';
        if (isFav) favBtn.classList.add('active');
        favBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(a.id); });

        const audioBtn = $('.btn-audio', node);
        audioBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            playArticle(a.id);
        });

        const shareBtn = $('.btn-share', node);
        shareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openShareDialog(a.title, a.bodyHTML.replace(/<[^>]+>/g, ' '));
        });

        const link = $('.deeplink', node);
        link.href = `#${a.id}`;
        link.addEventListener('click', e => {
            e.preventDefault(); e.stopPropagation();
            history.replaceState(null, '', `#${a.id}`);
            navigator.clipboard.writeText(window.location.href).then(showToast);
        });

        const noteBtn = $('.btn-note', node);
        const noteContainer = $('.note-container', node);
        const noteArea = $('.note-area', node);

        if (state.notes[a.id]) {
            noteArea.value = state.notes[a.id];
            noteContainer.hidden = false;
            noteBtn.classList.add('active');
        }

        noteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            noteContainer.hidden = !noteContainer.hidden;
            if (!noteContainer.hidden) noteArea.focus();
        });

        noteArea.addEventListener('input', debounce((e) => {
            saveNote(a.id, e.target.value);
            if (e.target.value.trim()) noteBtn.classList.add('active');
            else noteBtn.classList.remove('active');
        }, 500));

        if (a.title.includes('–°—Ç–∞—Ç—å—è 65')) {
            const mapBtn = document.createElement('button');
            mapBtn.className = 'btn btn-primary';
            mapBtn.style.marginTop = '10px';
            mapBtn.innerHTML = 'üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –†–§';
            mapBtn.onclick = () => $('#mapDialog').showModal();
            $('.body', node).appendChild(mapBtn);
        }

        container.append(node);
    });

    initDynamicEvents(container);
}

function openShareDialog(title, text) {
    const dlg = $('#shareDialog');
    const canvas = $('#shareCanvas');
    if (!dlg || !canvas) return;

    generateQuoteImage(canvas, title, text);
    dlg.showModal();

    safeAddListener('#closeShare', 'click', () => dlg.close());

    $('#downloadImgBtn').onclick = () => {
        const link = document.createElement('a');
        link.download = `constitution-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    };

    $('#shareNativeBtn').onclick = () => {
        canvas.toBlob(blob => {
            const file = new File([blob], "quote.png", { type: "image/png" });
            if (navigator.share) {
                navigator.share({
                    files: [file],
                    title: '–¶–∏—Ç–∞—Ç–∞ –∏–∑ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏',
                    text: `${title}\n${text.substring(0, 50)}...`
                }).catch(console.error);
            } else {
                showToast("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫");
            }
        });
    };
}

function generateQuoteImage(canvas, title, text) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;

    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, '#12141a');
    grad.addColorStop(1, '#1e2330');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, w, h);

    ctx.strokeStyle = '#2563eb';
    ctx.lineWidth = 20;
    ctx.strokeRect(40, 40, w - 80, h - 80);

    ctx.fillStyle = '#6ea8fe';
    ctx.font = 'bold 80px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(title, w / 2, 200);

    ctx.fillStyle = '#e8ebf0';
    ctx.font = '50px sans-serif';
    ctx.textAlign = 'center';

    wrapText(ctx, text, w / 2, 350, w - 200, 80);

    ctx.fillStyle = '#9aa3af';
    ctx.font = 'italic 40px sans-serif';
    ctx.fillText('PrepMate ‚Äî –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è', w / 2, h - 100);
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    let testLine = '';

    if (words.length > 80) text = words.slice(0, 80).join(' ') + '...';

    for (let n = 0; n < words.length; n++) {
        testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);
        let testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
        }
        else {
            line = testLine;
        }
    }
    ctx.fillText(line, x, y);
}

function initDynamicEvents(container) {
    const tooltip = $('#tooltip');
    container.querySelectorAll('.term').forEach(term => {
        term.addEventListener('mouseenter', (e) => {
            const def = DICTIONARY[term.dataset.term];
            if (def && tooltip) {
                tooltip.innerHTML = `<b>${term.dataset.term}</b>${def}`;
                tooltip.classList.add('show');
                moveTooltip(e);
            }
        });
        term.addEventListener('mousemove', (e) => { if (tooltip) moveTooltip(e); });
        term.addEventListener('mouseleave', () => { if (tooltip) tooltip.classList.remove('show'); });
    });
    container.querySelectorAll('.cross-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            state.returnPosition = window.scrollY; state.isJumping = true;
            const targetId = link.dataset.target;
            const el = document.getElementById(targetId);
            if (el) {
                const offset = 80;
                const elementPosition = el.getBoundingClientRect().top + window.scrollY;
                window.scrollTo({ top: elementPosition - offset, behavior: "smooth" });
                state.landingPosition = elementPosition - offset;
                showReturnButton();
                el.classList.add('highlight');
                setTimeout(() => { el.classList.remove('highlight'); state.isJumping = false; }, 1000);
            }
        });
    });
}

function moveTooltip(e) {
    const tooltip = $('#tooltip'); if (!tooltip) return;
    const x = e.clientX; const y = e.clientY;
    tooltip.style.left = (x + 15) + 'px'; tooltip.style.top = (y + 15) + 'px';
    if (x + 320 > window.innerWidth) tooltip.style.left = (x - 315) + 'px';
    if (y + 100 > window.innerHeight) tooltip.style.top = (y - 100) + 'px';
}

function showToast(msg = "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!") {
    const toast = $('#toast'); if (!toast) return;
    toast.textContent = msg;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

function initDictionary() {
    safeAddListener('#dictionaryBtn', 'click', () => {
        const dlg = $('#dictionaryDialog'); if (!dlg) return;
        const list = $('#dictionaryList');
        if (list && list.innerHTML === '') {
            Object.keys(DICTIONARY).sort().forEach(term => {
                const div = document.createElement('div');
                div.className = 'dict-item';
                div.innerHTML = `<span class="dict-term">${term.charAt(0).toUpperCase() + term.slice(1)}</span><span class="dict-def">${DICTIONARY[term]}</span>`;
                list.appendChild(div);
            });
        }
        dlg.showModal();
    });
    safeAddListener('#closeDictionary', 'click', () => $('#dictionaryDialog').close());
}

function initAudioPlayer() {
    const player = $('#audioPlayer');
    const playBtn = $('#playerPlayPause');
    const rateBtn = $('#playerRate');
    const bar = $('#playerBar');

    if (!player) return;

    // Toggle Player Visibility Button
    safeAddListener('#openPlayerBtn', 'click', () => {
        player.hidden = !player.hidden;
    });

    safeAddListener('#playerPlayPause', 'click', () => {
        if (window.speechSynthesis.speaking) {
            if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
                playBtn.textContent = '‚è∏';
            } else {
                window.speechSynthesis.pause();
                playBtn.textContent = '‚ñ∂';
            }
        } else if (state.audio.currentArticleId) {
            playArticle(state.audio.currentArticleId);
        }
    });

    safeAddListener('#playerClose', 'click', () => {
        window.speechSynthesis.cancel();
        player.hidden = true;
    });

    safeAddListener('#playerRate', 'click', () => {
        const rates = [1.0, 1.5, 2.0];
        let idx = rates.indexOf(state.audio.rate);
        state.audio.rate = rates[(idx + 1) % rates.length];
        rateBtn.textContent = `x${state.audio.rate}`;
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            playArticle(state.audio.currentArticleId);
        }
    });

    safeAddListener('#playerNext', 'click', playNextArticle);
    safeAddListener('#playerPrev', 'click', playPrevArticle);

    setInterval(() => {
        if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
            const w = parseFloat(bar.style.width) || 0;
            bar.style.width = ((w + 1) % 100) + '%';
        }
    }, 100);
}

function playArticle(id) {
    const article = state.articles.find(a => a.id === id);
    if (!article) return;

    window.speechSynthesis.cancel();
    state.audio.currentArticleId = id;

    const text = article.bodyHTML.replace(/<[^>]+>/g, ' ');
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ru-RU';
    utterance.rate = state.audio.rate;

    utterance.onstart = () => {
        $('#audioPlayer').hidden = false;
        $('#playerTitle').textContent = article.title;
        $('#playerPlayPause').textContent = '‚è∏';
        state.audio.isPlaying = true;
    };

    utterance.onend = () => {
        $('#playerPlayPause').textContent = '‚ñ∂';
        state.audio.isPlaying = false;
        playNextArticle();
    };

    window.speechSynthesis.speak(utterance);
}

function playNextArticle() {
    if (!state.audio.currentArticleId) return;
    const idx = state.articles.findIndex(a => a.id === state.audio.currentArticleId);
    if (idx !== -1 && idx < state.articles.length - 1) {
        playArticle(state.articles[idx + 1].id);
    }
}

function playPrevArticle() {
    if (!state.audio.currentArticleId) return;
    const idx = state.articles.findIndex(a => a.id === state.audio.currentArticleId);
    if (idx > 0) {
        playArticle(state.articles[idx - 1].id);
    }
}

/* --- IMPROVED MAP LOGIC (ZOOM) --- */
function initMap() {
    safeAddListener('#closeMap', 'click', () => $('#mapDialog').close());
    const title = $('#mapRegionTitle');
    const list = $('#mapRegionList');
    const zoomLayer = $('#zoomLayer');

    // Zoom Controls
    safeAddListener('#zoomIn', 'click', () => changeZoom(0.3));
    safeAddListener('#zoomOut', 'click', () => changeZoom(-0.3));
    safeAddListener('#zoomReset', 'click', () => { state.mapZoom = 1; state.mapPan = { x: 0, y: 0 }; updateMapTransform(); });

    // Click on region
    $$('.region').forEach(reg => {
        reg.addEventListener('click', (e) => {
            const id = e.target.id;
            const data = FEDERAL_DISTRICTS[id];
            if (data) {
                title.textContent = data.title;
                list.innerHTML = '';
                const items = data.list.split(',').map(s => s.trim());
                items.forEach(i => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="flag-placeholder"></span> ${i}`;
                    list.appendChild(li);
                });
            }
        });
    });

    // Drag Logic
    const container = $('#mapContainer');
    let isDragging = false;
    let startX, startY;

    container.addEventListener('mousedown', e => { isDragging = true; startX = e.clientX - state.mapPan.x; startY = e.clientY - state.mapPan.y; });
    window.addEventListener('mouseup', () => isDragging = false);
    container.addEventListener('mousemove', e => {
        if (!isDragging) return;
        e.preventDefault();
        state.mapPan.x = e.clientX - startX;
        state.mapPan.y = e.clientY - startY;
        updateMapTransform();
    });
}

function changeZoom(delta) {
    state.mapZoom = Math.max(1, Math.min(3, state.mapZoom + delta));
    updateMapTransform();
}

function updateMapTransform() {
    const layer = $('#zoomLayer');
    if (layer) {
        layer.style.transform = `translate(${state.mapPan.x}px, ${state.mapPan.y}px) scale(${state.mapZoom})`;
    }
}

function initMobileNav() {
    safeAddListener('#navHome', 'click', () => scrollToTop());
    safeAddListener('#navSearch', 'click', () => { $('#searchInput').focus(); scrollToTop(); });
    safeAddListener('#navFav', 'click', () => { setFavFilterMode(); $('#navFav').classList.toggle('active'); });
    safeAddListener('#navMenu', 'click', () => { $('#sidebarPanel').classList.toggle('visible'); });
}

/* --- INIT FOLDERS UI HANDLERS --- */
function initFoldersUI() {
    safeAddListener('#addFolderBtn', 'click', () => {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
        if (name && !state.favFolders.includes(name)) {
            state.favFolders.push(name);
            saveFolders();
            renderFolderSelect();
        }
    });

    const select = $('#folderSelectFilter');
    if (select) {
        select.addEventListener('change', (e) => {
            state.currentFolderFilter = e.target.value;
            renderArticles();
        });
    }
}

function initPWAInstall() {
    let deferredPrompt;
    const btn = $('#installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        btn.hidden = false; // Show button in header
    });

    btn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            btn.hidden = true;
        }
    });
}

function initEvents() {
    safeAddListener('#themeToggle', 'click', toggleTheme);
    safeAddListener('#printBtn', 'click', () => window.print());
    safeAddListener('#markersBtn', 'click', () => setMarkersMode(!state.markersMode));
    safeAddListener('#favFilterBtn', 'click', setFavFilterMode);
    safeAddListener('#closeDialog', 'click', () => $('#articleDialog').close());

    $$('dialog').forEach(dlg => {
        dlg.addEventListener('click', (e) => {
            const rect = dlg.getBoundingClientRect();
            if (e.clientX < rect.left || e.clientX > rect.right ||
                e.clientY < rect.top || e.clientY > rect.bottom) {
                dlg.close();
            }
        });
    });

    const searchInput = $('#searchInput');
    const searchBtn = $('#searchTriggerBtn');
    if (searchInput) searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(searchInput.value); });
    if (searchBtn) searchBtn.addEventListener('click', () => { if (searchInput) performSearch(searchInput.value); });

    safeAddListener('#backToTop', 'click', scrollToTop);
    safeAddListener('#btn-return', 'click', returnBack);

    const content = $('#content');
    if (content) {
        content.addEventListener('click', e => {
            if (e.target.closest('.player-btn') || e.target.closest('.sheet-btn')) return;

            if (e.target.closest('.term') || e.target.closest('.cross-link') || e.target.closest('button') || e.target.closest('.note-area') || e.target.closest('select')) return;
            const card = e.target.closest('.card');
            if (card && e.altKey) openDialogById(card.dataset.articleId);
        });
        content.addEventListener('dblclick', e => {
            if (e.target.closest('.term') || e.target.closest('.cross-link') || e.target.closest('button') || e.target.closest('.note-area') || e.target.closest('select')) return;
            const card = e.target.closest('.card');
            if (card) openDialogById(card.dataset.articleId);
        });
    }

    window.addEventListener('hashchange', () => {
        const hash = location.hash.replace('#', ''); if (!hash) return;
        const target = document.getElementById(hash);
        if (target) { target.scrollIntoView({ behavior: 'smooth', block: 'center' }); target.classList.add('highlight'); setTimeout(() => target.classList.remove('highlight'), 1500); }
    });
    window.addEventListener('scroll', updateScrollState);
    window.addEventListener('keydown', e => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); $('#searchInput').focus(); }
    });
}

function initServiceWorker() {
    if ('serviceWorker' in navigator) {
        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            window.location.reload();
            refreshing = true;
        });

        navigator.serviceWorker.register('./sw.js').then(reg => {
            reg.update();
            const showUpdateUI = (worker) => {
                const toast = $('#updateNotification');
                const btn = $('#reloadBtn');
                if (toast && btn) {
                    toast.hidden = false;
                    btn.onclick = () => {
                        btn.disabled = true;
                        btn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                        worker.postMessage({ type: 'SKIP_WAITING' });
                    };
                }
            };
            if (reg.waiting) { showUpdateUI(reg.waiting); return; }
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateUI(newWorker);
                    }
                });
            });
        }).catch(err => console.error('SW Error:', err));
    }
}

async function loadChapters() {
    const container = $('#content');
    const cachedData = localStorage.getItem(LS.CACHE_CHAPTERS);
    if (cachedData) {
        try {
            state.articles = JSON.parse(cachedData);
            renderArticles(); buildTOC();
            if (container) container.classList.remove('loading');
        } catch (e) { console.error(e); }
    }

    try {
        const files = [
            'chapters/chapter1.html', 'chapters/chapter2.html', 'chapters/chapter3.html',
            'chapters/chapter4.html', 'chapters/chapter5.html', 'chapters/chapter6.html',
            'chapters/chapter7.html', 'chapters/chapter8.html', 'chapters/chapter9.html'
        ];

        const results = await Promise.allSettled(files.map(f => fetch(f).then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.text();
        })));

        let newArticles = [];
        const parser = new DOMParser();

        results.forEach((res, index) => {
            if (res.status === 'fulfilled') {
                const html = res.value;
                const doc = parser.parseFromString(html, 'text/html');
                const chapterTitle = doc.querySelector('h2')?.textContent?.trim() || `–ì–ª–∞–≤–∞ ${index + 1}`;
                doc.querySelectorAll('article.interactive-article, article').forEach(artNode => {
                    const id = artNode.id || `article-${index}-${Math.random().toString(36).slice(2, 7)}`;
                    const title = artNode.getAttribute('data-title') || artNode.querySelector('h3')?.textContent?.trim() || '–°—Ç–∞—Ç—å—è';

                    // –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—è—Å–Ω–µ–Ω–∏–π
                    let explain = artNode.getAttribute('data-comment') || '';
                    const explainNode = artNode.querySelector('.explanation-source');
                    if (explainNode) {
                        explain = explainNode.innerHTML;
                        explainNode.remove();
                    }

                    const bodyClone = artNode.cloneNode(true);
                    bodyClone.querySelector('h3')?.remove();
                    newArticles.push({ id, title, bodyHTML: bodyClone.innerHTML, explainHTML: explain, chapterTitle });
                });
            } else {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã ${index + 1}:`, res.reason);
            }
        });

        if (newArticles.length > 0) {
            state.articles = newArticles;
            try { localStorage.setItem(LS.CACHE_CHAPTERS, JSON.stringify(newArticles)); } catch (e) { }
            renderArticles(); buildTOC(); applyFontSettings();
        } else if (!cachedData) {
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –≥–ª–∞–≤—ã.");
        }

        if (container) container.classList.remove('loading');
        updateScrollState();
    } catch (e) {
        if (!state.articles.length && container) {
            container.innerHTML = `<div class="error" style="color:red;padding:20px;border:1px solid red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</div>`;
        }
    }
}

function openDialogById(id) {
    const art = state.articles.find(x => x.id === id); if (!art) return;
    const dlg = $('#articleDialog'); if (!dlg) return;
    $('#dialogTitle').textContent = art.title;
    $('#dialogBody').innerHTML = processText(art.bodyHTML) + (art.explainHTML ? `<hr><div class="muted">–ü–æ—è—Å–Ω–µ–Ω–∏–µ:</div>${processText(art.explainHTML)}` : '');
    initDynamicEvents($('#dialogBody'));
    dlg.showModal();
}

function boot() {
    if (window.speechSynthesis) window.speechSynthesis.cancel(); // Force stop audio

    applyTheme(true);
    const markersMode = localStorage.getItem(LS.MARKERS) === '1'; state.markersMode = markersMode;
    const mBtn = $('#markersBtn'); if (mBtn) mBtn.setAttribute('aria-pressed', markersMode ? 'true' : 'false');

    loadFavorites();
    loadNotes();
    initFontSettings();
    initSearchHistory();
    initTimer();
    initGame();
    initGame23();
    initFlashcards();
    initDictionary();
    initMap();
    initMobileNav();
    initFoldersUI();
    initEvents();
    initSpyScroll();
    initContextMenu();
    initAudioPlayer();
    initPWAInstall();
    initServiceWorker();
    loadChapters();
}

document.addEventListener('DOMContentLoaded', boot);